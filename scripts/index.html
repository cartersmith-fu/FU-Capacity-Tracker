<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PAC Network Occupancy Monitor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body class="bg-gradient-to-br from-slate-900 to-slate-800 min-h-screen">
    <div id="app" class="p-8">
        <div class="max-w-7xl mx-auto">
            <!-- Header -->
            <div class="mb-8">
                <h1 class="text-4xl font-bold text-white mb-2 flex items-center gap-3">
                    <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
                    </svg>
                    Network Occupancy Monitor
                </h1>
                <p class="text-slate-400">Real-time network activity tracking</p>
            </div>

            <div class="w-full bg-slate-700 rounded-full h-6 mb-4">
  <div id="occupancy-bar" class="bg-green-500 h-6 rounded-full" style="width: 30%"></div>
</div>
<div class="text-slate-400 text-sm">Occupancy: 30%</div>

<!-- Add this above your stats cards (after the occupancy status section) -->
<div class="mb-6">
  <div class="flex items-center gap-3 text-slate-300 text-sm">
    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full bg-green-900 text-green-200 font-medium">Active</span>
    <span> a device is currently connected and present in the building.</span>
  </div>
  <div class="flex items-center gap-3 text-slate-300 text-sm mt-1">
    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full bg-slate-700 text-slate-400 font-medium">Inactive</span>
    <span> a device was recently disconnected or not present.</span>
  </div>
</div>

<!-- Example: Add this above your stats cards -->
<div class="mb-8 flex items-center gap-4">
  <span id="occupancy-status" class="text-3xl font-bold px-4 py-2 rounded-lg bg-green-600 text-white">Quiet</span>
  <span class="text-slate-400">Current building status</span>
</div>
            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-slate-800 rounded-xl p-6 border border-slate-700">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-slate-400 text-sm">Active Connections</span>
                        <svg class="text-green-400" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M5 13a10 10 0 0 1 14 0"/><path d="M8.5 16.5a5 5 0 0 1 7 0"/><path d="M12 20h.01"/>
                        </svg>
                    </div>
                    <div id="active-count" class="text-3xl font-bold text-white">-</div>
                </div>

                <div class="bg-slate-800 rounded-xl p-6 border border-slate-700">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-slate-400 text-sm">Inactive Periods</span>
                        <svg class="text-slate-500" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="2" y1="2" x2="22" y2="22"/><path d="M8.5 16.5a5 5 0 0 1 7 0"/>
                        </svg>
                    </div>
                    <div id="inactive-count" class="text-3xl font-bold text-white">-</div>
                </div>

                <div class="bg-slate-800 rounded-xl p-6 border border-slate-700">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-slate-400 text-sm">Unique Devices</span>
                        <svg class="text-blue-400" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/>
                        </svg>
                    </div>
                    <div id="unique-count" class="text-3xl font-bold text-white">-</div>
                </div>

                <div class="bg-slate-800 rounded-xl p-6 border border-slate-700">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-slate-400 text-sm">Activity Rate</span>
                        <svg class="text-purple-400" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
                        </svg>
                    </div>
                    <div id="activity-rate" class="text-3xl font-bold text-white">-</div>
                </div>
            </div>

            <!-- Chart -->
            <div class="bg-slate-800 rounded-xl p-6 border border-slate-700 mb-8">
                <h2 class="text-xl font-semibold text-white mb-4">Activity Timeline</h2>
                <canvas id="activityChart" height="80"></canvas>
            </div>

            <!-- Recent Activity Table -->
            <div class="bg-slate-800 rounded-xl border border-slate-700 overflow-hidden mb-8">
                <div class="p-6 border-b border-slate-700">
                    <h2 class="text-xl font-semibold text-white">Recent Activity</h2>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-slate-900">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">Time</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">IP Address</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">Status</th>
                            </tr>
                        </thead>
                        <tbody id="activity-table" class="divide-y divide-slate-700">
                            <tr><td colspan="3" class="px-6 py-4 text-center text-slate-400">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Connected Devices -->
            <div id="devices-section" class="bg-slate-800 rounded-xl p-6 border border-slate-700">
                <h2 class="text-xl font-semibold text-white mb-4">Connected Devices</h2>
                <div id="devices-list" class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    <div class="text-slate-400">Loading...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let chart = null;

        async function fetchData() {
            try {
                const response = await fetch('https://cartersmith.pythonanywhere.com/api/occupancy');
                const data = await response.json();
                updateDashboard(data);
            } catch (error) {
                console.error('Error fetching data:', error);
                document.getElementById('active-count').textContent = 'Error';
            }
        }

        function updateDashboard(data) {
            const entries = Object.entries(data);
            let active = 0;
            let inactive = 0;
            const uniqueIPs = new Set();

            // Calculate stats
            entries.forEach(([_, ip]) => {
                if (ip === '0.0.0.0') {
                    inactive++;
                } else {
                    active++;
                    uniqueIPs.add(ip);
                }
            });

            const activityRate = entries.length > 0 ? ((active / entries.length) * 100).toFixed(1) : 0;

            // Update stats
            document.getElementById('active-count').textContent = active;
            document.getElementById('inactive-count').textContent = inactive;
            document.getElementById('unique-count').textContent = uniqueIPs.size;
            document.getElementById('activity-rate').textContent = activityRate + '%';

            // Update chart
            updateChart(entries);

            // Update table
            updateTable(entries);

            // Update devices
            updateDevices(uniqueIPs);
        }

        function updateChart(entries) {
            const grouped = {};
            
            entries.forEach(([timestamp, ip]) => {
                const minute = timestamp.substring(0, 16); // Group by minute
                if (!grouped[minute]) {
                    grouped[minute] = { time: minute.split(' ')[1], active: 0, total: 0 };
                }
                grouped[minute].total++;
                if (ip !== '0.0.0.0') grouped[minute].active++;
            });

            const chartData = Object.values(grouped).slice(-20);
            const labels = chartData.map(d => d.time);
            const activeData = chartData.map(d => d.active);
            const totalData = chartData.map(d => d.total);

            const ctx = document.getElementById('activityChart').getContext('2d');
            
            if (chart) {
                chart.destroy();
            }

            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Active',
                            data: activeData,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'Total',
                            data: totalData,
                            borderColor: '#6366f1',
                            backgroundColor: 'rgba(99, 102, 241, 0.1)',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            labels: { color: '#94a3b8' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: '#334155' }
                        },
                        y: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: '#334155' }
                        }
                    }
                }
            });
        }

        function updateTable(entries) {
            const recent = entries.slice(-10).reverse();
            const tableBody = document.getElementById('activity-table');
            
            tableBody.innerHTML = recent.map(([time, ip]) => {
                const isActive = ip !== '0.0.0.0';
                const statusBadge = isActive 
                    ? '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-900 text-green-200">Active</span>'
                    : '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-slate-700 text-slate-400">Inactive</span>';
                
                return `
                    <tr class="hover:bg-slate-700 transition-colors">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-300">${time.split(' ')[1]}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-mono text-slate-300">${ip}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${statusBadge}</td>
                    </tr>
                `;
            }).join('');
        }

        function updateDevices(uniqueIPs) {
            const devicesList = document.getElementById('devices-list');
            
            if (uniqueIPs.size === 0) {
                devicesList.innerHTML = '<div class="text-slate-400">No active devices</div>';
                return;
            }

            devicesList.innerHTML = Array.from(uniqueIPs).map(ip => `
                <div class="bg-slate-900 rounded-lg p-3 border border-slate-700">
                    <span class="text-sm font-mono text-slate-300">${ip}</span>
                </div>
            `).join('');
        }

        // Initial fetch and set up auto-refresh
        fetchData();
        setInterval(fetchData, 30000); // Refresh every 30 seconds
    </script>
</body>
</html>